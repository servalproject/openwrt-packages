<html>
<head>
    <title>Serval Mesh Extender</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link href="style.css" type="text/css" rel="stylesheet"></link>
</head>
<body>
    <div id="flags">
        <div class="flag">
            <a href="splash_bislama.html">
                <img src="flag_vanuatu.png"/>
            </a>
        </div>
        <div class="flag">
            <a href="splash_french.html">
                <img src="flag_france.png"/>
            </a>
        </div>
        <div class="flag">
            <a href="imagesdir/../splash.html">
                <img src="flag_england.png"/>
            </a>
        </div>
    </div>
    <div id="header">
        <img src="serval_logo.png"/ id="logo">
        <h1>Bienvenu sur ce Serval Mesh Extender</h1>
        <div id="description">
            <p>
                Cet appareil expérimental vous aide à communiquer avec les personnes aux alentours, même sans la présence de réseau cellulaire. Pour utiliser cet appareil, vous et les personnes avec lesquelles vous voulez communiquer devez installer l'application Serval Mesh. Vous pouvez faire cela en suivant les instructions sur cette page.
            </p>
            <p>
                Comme ce projet est expérimental et parce qu'il dépend des appareils Serval Mesh Extender, il ne fonctionne pas exactement comme le réseau cellulaire. Vos messages peuvent prendre quelques minutes voire des heures avant d'être réceptionnés (ou peuvent être perdus s'ils n'ont aucun moyen d'être transférés. Cependant, il essaye très fort de les envoyer par tous les moyens possibles). 
            </p>
        </div>
    </div>

    <div id="content">
        <p>
            Pour installer l'application Android Serval Mesh, copiez-collez ce lien dans Google Chrome :
        </p>
        <p>
            http://servalmesh.au
        </p>
        <p>
            Une fois sur Google Chrome, appuyez sur ce bouton pour obtenir la procédure d'installation :
            <a id="linkAndroidVersion" href="#"> 
                <button class="width-button">Procedure d'installation</button>
            </a>      
            If the button above doesn't work, you can download the Android App <a href="/images/ServalChat.apk">here</a>.
        </p>

        <div id="neighbours">
            <h2>Mesh Extenders en portée :</h2>
            <lu id="neighbours-list">
            </lu>
        </div>
        <div id="transfers">
            <h2>Liste des transferts</h2>
            <lu id="transfers-list">
            </lu>
        </div>
        <div id="links">
            <a id="linkDNAStatus" href="#"> 
                Diagnostique
            </a> 
            <!-- <a id="linkLBARDStatus" href="#"> 
                <button class="width-button">Serval LBARD Status</button>
            </a>  -->      
        </div>
        
    </div>
    <div id="footer">
        <p>
            Si vous avez des questions sur ce système, envoyez un SMS au +678 7711139 ou envoyez un email à paul.gardner-stephen@flinders.edu.au.
        </p>
    </div>
</body>
<script>
    //Getting the neighbours list
    window.setInterval(function(){          
        var neighboursList = document.getElementById("neighbours-list");
        var transfersList = document.getElementById("transfers-list");  

        //Removing every previous children from the list
        while(neighboursList.firstChild){
            neighboursList.removeChild(neighboursList.firstChild);
        }

        while(transfersList.firstChild){
            transfersList.removeChild(transfersList.firstChild);
        }

        //Fetch the json file
        window.fetch( window.location.protocol + '//' + window.location.hostname + ':21506/status.json')
        .then(res => res.json())
        .then(resJson => {
            console.log(resJson);
            var responseNeighbours = resJson["neighbours"];

            var responseTransfers = resJson["transfers"];

            //insert in html
            var neighboursList = document.getElementById("neighbours-list");
            for(var i=0; i<responseNeighbours.length; i++){
                var li = document.createElement("li");
                var lastTime = responseNeighbours[i]["time-since-last"];
                if(lastTime <= 3)
                    li.style.color = 'green';
                else{
                    if(lastTime <= 10)
                        li.style.color = 'orange';
                    else
                        li.style.color = 'red';
                }

                li.innerHTML = responseNeighbours[i]["id"] + ': ' + responseNeighbours[i]["time-since-last"]+'s';
                neighboursList.appendChild(li);
            }

            var transfersList = document.getElementById("transfers-list");
            for(i=0; i<responseTransfers.length; i++){
                var li = document.createElement("li");
                li.innerHTML = responseTransfers[i]["id"]+ ': ' + responseTransfers[i]["version"] + ': ' + responseTransfers[i]["progress"];
                transfersList.appendChild(li);
            }
        })
        .catch(err => console.log(err));
    }, 5000); 

    //Getting android version from the user Agent
    /*var ua = navigator.userAgent;             
    if(ua.indexOf("Android") >= 0)                   
    {                                   
        //Regex to get the android version            
        var regex = /Android\s+([\d\.]+)/;
        var androidVersion = regex.exec(ua)[1].split(".")[0];
        // document.getElementById("androidVersion").innerHTML = androidVersion;
        if(androidVersion>5)
            document.getElementById("linkAndroidVersion").href = "$imagesdir/Android"+androidVersion+".html";
        else
            document.getElementById("linkAndroidVersion").href = "$imagesdir/Android5.html";
    }*/
    document.getElementById("linkAndroidVersion").href = "Android7_french.html";
           

    //DNA Status link
    document.getElementById("linkDNAStatus").href = window.location.protocol + '//' + window.location.hostname + ':4110/';

    //LBARD Status link
    // document.getElementById("linkLBARDStatus").href = window.location.protocol + '//' + window.location.hostname + ':21506/';
</script>
</html>
