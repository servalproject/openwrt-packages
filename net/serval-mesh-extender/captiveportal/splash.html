<html>
<head>
    <title>Serval Mesh Extender</title>
    <meta HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <link href="$imagesdir/style.css" type="text/css" rel="stylesheet"></link>
</head>
<body>
    <div id="flags">
        <div class="flag">
            <a href="$imagesdir/splash_bislama.html">
                <img src="$imagesdir/flag_vanuatu.png"/>
            </a>
        </div>
        <div class="flag">
            <a href="$imagesdir/splash_french.html">
                <img src="$imagesdir/flag_france.png"/>
            </a>
        </div>
        <div class="flag">
            <a href="$imagesdir/../splash.html">
                <img src="$imagesdir/flag_england.png"/>
            </a>
        </div>
    </div>
    <div id="header">
        <img src="$imagesdir/serval_logo.png"/ id="logo">
        <h1>Welcome to this Serval Mesh Extender</h1>
        <div id="description">
            <p>
                This is an experimental device that can help you communicate with people nearby, even if there is no cellular signal.  To use this service, you, and the people you want to communicate with, need to install the Serval Mesh application. You can do this by following the instructions on this page.
            </p>
            <p>
                Because it is still experimental, and because it relies on the little Serval Mesh Extender devices, it doesn't work the same as a cellular network.  Your messages to other people might take minutes or hours to be delivered -- or might not be delivered at all if there is no way for this to happen. However, it tries very hard to deliver by any means possible.
            </p>
        </div>
    </div>

    <div id="content">
        <p>
            To install the Serval Mesh Android app, please copy-paste this link in Google Chrome:
        </p>
        <p>
            http://servalmesh.au
        </p>
        <p>
            Once it's done, click here to get the installation procedure:
            <a id="linkAndroidVersion" href="#"> 
                <button class="width-button">Installation procedure</button>
            </a> 
            The Android APK file can be directly downloaded <a href="/images/ServalChat.apk">here</a>.
     
        </p>

        <div id="neighbours">
            <h2>Mesh Extenders in range:</h2>
            <lu id="neighbours-list">
            </lu>
        </div>
        <div id="transfers">
            <h2>Transfers list:</h2>
            <lu id="transfers-list">
            </lu>
        </div>
        <div id="links">
            <a id="linkDNAStatus" href="#"> 
                Diagnostic
            </a> 
            <!-- <a id="linkLBARDStatus" href="#"> 
                <button class="width-button">Serval LBARD Status</button>
            </a>  -->      
        </div>
        
    </div>
    <div id="footer">
        <p>
            If you have any questions about this system, please SMS to +678 7711139 or send email to paul.gardner-stephen@flinders.edu.au.      
        </p>
    </div>
</body>
<script>
    //Getting the neighbours list
    window.setInterval(function(){          
        var neighboursList = document.getElementById("neighbours-list");
        var transfersList = document.getElementById("transfers-list");  

        //Removing every previous children from the list
        while(neighboursList.firstChild){
            neighboursList.removeChild(neighboursList.firstChild);
        }

        while(transfersList.firstChild){
            transfersList.removeChild(transfersList.firstChild);
        }

        //Fetch the json file
        window.fetch( window.location.protocol + '//' + window.location.hostname + ':21506/status.json')
        .then(res => res.json())
        .then(resJson => {
            console.log(resJson);
            var responseNeighbours = resJson["neighbours"];

            var responseTransfers = resJson["transfers"];

            //insert in html
            var neighboursList = document.getElementById("neighbours-list");
            for(var i=0; i<responseNeighbours.length; i++){
                var li = document.createElement("li");
                var lastTime = responseNeighbours[i]["time-since-last"];
                if(lastTime <= 3)
                    li.style.color = 'green';
                else{
                    if(lastTime <= 10)
                        li.style.color = 'orange';
                    else
                        li.style.color = 'red';
                }

                li.innerHTML = responseNeighbours[i]["id"] + ': ' + responseNeighbours[i]["time-since-last"]+'s';
                neighboursList.appendChild(li);
            }

            var transfersList = document.getElementById("transfers-list");
            for(i=0; i<responseTransfers.length; i++){
                var li = document.createElement("li");
                li.innerHTML = responseTransfers[i]["id"]+ ': ' + responseTransfers[i]["version"] + ': ' + responseTransfers[i]["progress"];
                transfersList.appendChild(li);
            }
        })
        .catch(err => console.log(err));
    }, 5000); 

    //Getting android version from the user Agent
    /*var ua = navigator.userAgent;             
    if(ua.indexOf("Android") >= 0)                   
    {                                   
        //Regex to get the android version            
        var regex = /Android\s+([\d\.]+)/;
        var androidVersion = regex.exec(ua)[1].split(".")[0];
        // document.getElementById("androidVersion").innerHTML = androidVersion;
        if(androidVersion>5)
            document.getElementById("linkAndroidVersion").href = "$imagesdir/Android"+androidVersion+".html";
        else
            document.getElementById("linkAndroidVersion").href = "$imagesdir/Android5.html";
    }           */            
    document.getElementById("linkAndroidVersion").href = "$imagesdir/Android7_english.html";


    //DNA Status link
    document.getElementById("linkDNAStatus").href = window.location.protocol + '//' + window.location.hostname + ':4110/';

    //LBARD Status link
    // document.getElementById("linkLBARDStatus").href = window.location.protocol + '//' + window.location.hostname + ':21506/';
</script>
</html>
